{% extends 'base.html' %}

{% load static %}

{% block head_css %}
<link rel="stylesheet" href="{% static 'css/style-singlemap.css' %}">
{% endblock %}

{% block content %}

<div class="detail-flight">
  <div id="map"></div>
  <div class="infos">
    <h1 class="title is-5 is-clickable">{{ object.name }}</h1>
    <h2 class="subtitle is-6"><em>{{ object.description }}</em></h2>

    <p><strong>Latitude:</strong> {{ object.lat }}</p>
    <p><strong>Longitude:</strong> {{ object.lon }}</p>

    <p class="is-flex is-justify-content-space-between mt-5">
      <a class="button is-info" title="Edit this picture" href="{% url 'pictures:update' object.pk %}"><i class="mdi mdi-square-edit-outline"></i></a>
      <button class="button is-danger" id="open-delete-modal"><i class="mdi mdi-delete"></i></button>
    </p>

    <img src="{{ object.data_file.url }}">
  </div>
</div>

<div class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Are you sure?</p>
    </header>
    <section class="modal-card-body">
      Are you sure you want to delete this picture?
    </section>
    <footer class="modal-card-foot is-flex is-justify-content-flex-end">
      <form method="post" action="{% url 'pictures:delete' object.pk %}">
        {% csrf_token %}
        <input type="submit" value="Yes, delete that!" class="button is-danger" >
      </form>
    </footer>
  </div>
</div>

{% comment %} TODO: on click on departure/arrival <p> tag, center map on airport {% endcomment %}

{% endblock %}

{% block footer_js %}
<script src="{% static 'js/bundle-singlemap.js' %}"></script>

<script>

document.querySelector('button#open-delete-modal').addEventListener('click', function(event) {
  event.preventDefault();
  var modal = document.querySelector('.modal');  // assuming you have only 1
  var html = document.querySelector('html');
  modal.classList.add('is-active');
  html.classList.add('is-clipped');

  modal.querySelector('.modal-background').addEventListener('click', function(e) {
    e.preventDefault();
    modal.classList.remove('is-active');
    html.classList.remove('is-clipped');
  });
});


var map = L.map('map').setView([47.4771198,-0.5972396], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);



{% if object.flight %}
let dep = [{{ object.flight.departure.lat }}, {{ object.flight.departure.lon }}]
let arr = [{{ object.flight.arrival.lat }}, {{ object.flight.arrival.lon }}]
let pts = [
{% for wp in object.flight.waypoints.all %}
  [{{ wp.lat }}, {{ wp.lon }}],
{% endfor %}
]

let polyline = drawFlight(dep, arr, pts, map)
map.fitBounds([dep, arr])
{% endif %}

let coords = [{{ object.lat }}, {{ object.lon }}]
L.marker(coords).addTo(map)

map.panTo(coords)


document.querySelector('.infos .title').addEventListener('click', function(event) {
  map.panTo(coords, {animate: true});
});

</script>
{% endblock %}
